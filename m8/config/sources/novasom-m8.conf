ARCH=arm64
KERNEL_IMAGE_TYPE=Image
OFFSET=163

BOOTSCRIPT='boot-novasom-m8.cmd:boot.cmd'
BOOTENV_FILE='qcom-default.txt'

UBOOT_TARGET_MAP=";;"
UBOOT_USE_GCC='> 7.0'

BOOTSOURCE='https://github.com/NovasomIndustries/u-boot-novasomM8-2017.11_2019.07.git'
BOOTDIR='u-boot-novasom-m8'
BOOTBRANCH='branch:master'
BOOTCONFIG="dragonboard410c_defconfig"
SERIALCON='ttyMSM0:115200'


BOOTDELAY=3
HAS_UUID_SUPPORT=yes
OVERLAY_PREFIX='qcom'
SERIALCON=ttyS2

ATFSOURCE='https://github.com/NovasomIndustries/arm-trusted-firmware'
ATFDIR='arm-trusted-firmware'
ATFBRANCH='branch:master'
ATF_USE_GCC='> 6.3'
GOVERNOR="powersave"

ATF_TARGET_MAP='PLAT=rk322xh DEBUG=1 bl31;;trust.bin'
CPUMIN="600000"
CPUMAX="1200000"

KERNELSOURCE='https://github.com/NovasomIndustries/linux-4.11.0-QualcommLinaro_2019.07.git'
KERNELBRANCH='branch:master'
KERNELDIR='linux-m8'
KERNEL_USE_GCC='< 7.0'

write_uboot_platform()
{
#  part	      seek		       size	   type  name
#  1          131072          132095   512.0 KiB   FFFF  sbl1
#  2          132096          133119   512.0 KiB   FFFF  rpm
#  3          133120          135167   1024.0 KiB  FFFF  tz
#  4          135168          136191   512.0 KiB   FFFF  hyp
#  5          262144          262175   16.0 KiB    FFFF  sec
#  6          262176          264223   1024.0 KiB  FFFF  aboot
#  7          264224          329759   32.0 MiB    FFFF  boot
#  8          329760          331807   1024.0 KiB  FFFF  devinfo
#  9          331808          462879   64.0 MiB    8300  bootpart
# 10          462880          593951   64.0 MiB    8300  configpart
# 11          593952         7802846   3.4 GiB     8300  rootfs

# 74784 is the number of busy blocks
# 38289408 bytes is the number of busy bytes
# 37392 is the number of kbytes
# offset is 163MB ( 162.015625 )


	src="${SRC}/packages/blobs/novasom-m8/bootblobs"
	dd if=$src/sbl1       of=$2 seek=131072 conv=notrunc status=progress
	dd if=$src/rpm        of=$2 seek=132096 conv=notrunc status=progress
	dd if=$src/tz         of=$2 seek=133120 conv=notrunc status=progress
	dd if=$src/hyp        of=$2 seek=135168 conv=notrunc status=progress
	dd if=$src/sec        of=$2 seek=262144 conv=notrunc status=progress
	dd if=$src/aboot      of=$2 seek=262176 conv=notrunc status=progress
	dd if=$src/devinfo    of=$2 seek=329760 conv=notrunc status=progress
	dd if=$src/bootpart   of=$2 seek=331808 conv=notrunc status=progress
	dd if=$src/configpart of=$2 seek=593952 conv=notrunc status=progress
}

setup_write_uboot_platform()
{
	if grep -q "ubootpart" /proc/cmdline; then
		local tmp=$(cat /proc/cmdline)
		tmp="${tmp##*ubootpart=}"
		tmp="${tmp%% *}"
		[[ -n $tmp ]] && local part=$(findfs PARTUUID=$tmp 2>/dev/null)
		[[ -n $part ]] && local dev=$(lsblk -n -o PKNAME $part 2>/dev/null)
		[[ -n $dev ]] && DEVICE="/dev/$dev"
	fi
}

uboot_custom_postprocess()
{
	echo "working in uboot_custom_postprocess"
	./dtbTool -o dt.img arch/arm/dts
	sync
	touch u-boot-dtb.bin u-boot.img dt.img
	chmod 777 u-boot-dtb.bin u-boot.img dt.img
	ls -la u-boot-dtb.bin u-boot.img dt.img
	echo "Executing mkbootimg"
	./mkbootimg --kernel=u-boot-dtb.bin --output=u-boot.img --dt=dt.img --pagesize 2048 --base 0x80000000 --ramdisk=rd --cmdline=""
	ls -la u-boot-dtb.bin u-boot.img dt.img
}

atf_custom_postprocess()
{
	echo "in atf_custom_postprocess"
}

family_tweaks()
{
	# enable root login via the serial console  ttys2 may be deprecated
	echo "ttyS2" >> ${SDCARD}/etc/securetty
	echo "ttyFIQ0" >> ${SDCARD}/etc/securetty
	HERE=`pwd`
	cd ${SDCARD}/etc/systemd/system
	rm serial-getty@ttyS2.service
	ln -s  /dev/null serial-getty@ttyS2.service
	cd ${SDCARD}/boot
	mv vmlinuz-4.4.167-novasom-m7 vmlinuz-4.4.167-novasom-m7.gz
	gzip -d vmlinuz-4.4.167-novasom-m7.gz
	cd ${HERE}
	
	echo "NOVAsomM7 family_tweaks on ${RELEASE}" >> /home/fil/log
	echo "Running dir is ${HERE}" >> /home/fil/log
	echo "cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/cpufrequtils ${SDCARD}/etc/default/cpufrequtils" >> /home/fil/log
	cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/cpufrequtils ${SDCARD}/etc/default/cpufrequtils
	cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/armbian-release ${SDCARD}/etc/armbian-release
	cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/hostname ${SDCARD}/etc/hostname
	cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/interfaces ${SDCARD}/etc/network/interfaces
	cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/hosts ${SDCARD}/etc/hosts
	cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/xfce4-desktop.xml ${SDCARD}/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml
	cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/${RELEASE}_nibkg.* ${SDCARD}/usr/share/backgrounds/xfce/novasomindustries_background.jpg
	cp ${SRC}/packages/blobs/novasom-m7/${RELEASE}_customizations/xfce4-panel.xml ${SDCARD}/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-panel.xml

#	if [[ $BOARD == z28pro ]]; then
#		echo "fdtfile=rockchip/rk3328-z28pro.dtb" >> $SDCARD/boot/armbianEnv.txt
#		chroot $SDCARD /bin/bash -c "systemctl --no-reload enable z28pro-bluetooth.service >/dev/null 2>&1"
#	fi

}

family_tweaks_bsp()
{
        if [[ $BOARD == z28pro ]]; then
                mkdir -p $destination/usr/local/bin
                # Bluetooth
                install -m 755 $SRC/packages/bsp/rk3328/z28pro/8822b_hciattach $destination/usr/bin
                install -m 755 $SRC/packages/bsp/rk3328/z28pro/start_bt.sh $destination/usr/local/bin
                cp $SRC/packages/bsp/rk3328/z28pro/z28pro-bluetooth.service $destination/lib/systemd/system/
        fi

}
